<!DOCTYPE html>
<html lang="en" class="bg-gradient-to-br from-purple-700 to-indigo-800 min-h-screen flex items-center justify-center">
<head>
  <meta charset="UTF-8" />
  <title>🚀 XemzID</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadeIn 0.8s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>

<body class="w-full flex items-center justify-center px-4">

  <div id="loginSection" class="w-full max-w-md bg-white/10 backdrop-blur rounded-2xl shadow-lg p-8 text-center text-white">
    <h1 class="text-xl font-bold mb-4">🔐 Login Panel</h1>
    <input id="loginUsername" type="text" placeholder="Username"
      class="w-full mb-4 px-4 py-3 rounded-full bg-white/20 text-white placeholder-white/70">
    <input id="loginPassword" type="password" placeholder="Password"
      class="w-full mb-6 px-4 py-3 rounded-full bg-white/20 text-white placeholder-white/70">
    <button id="loginBtn"
      class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 rounded-full">Login</button>
    <p id="loginError" class="text-red-300 text-sm mt-4 hidden"></p>
  </div>

  <div id="panelSection" class="hidden w-full max-w-md bg-white/10 backdrop-blur rounded-2xl shadow-lg p-8 text-center text-white">
    <div class="flex justify-between mb-4">
      <h1 class="text-xl font-bold">🚀 Create Panel</h1>
      <button id="logoutBtn" class="text-sm text-red-300 hover:text-red-500 underline">Logout</button>
    </div>
    <p class="text-sm mb-6">Isi nama panel & pilih plan ➜ klik Create untuk deploy server.</p>

    <input id="panelName" type="text" placeholder="Panel Name"
      class="w-full mb-4 px-4 py-3 rounded-full bg-white/20 text-white placeholder-white/70">
    <select id="panelPlan"
      class="w-full mb-6 px-4 py-3 rounded-full bg-white/20 text-white">
      <option value="">-- Pilih Plan --</option>
      <option value="1gb-v2">1GB</option>
      <option value="2gb-v2">2GB</option>
      <option value="3gb-v2">3GB</option>
    </select>

    <button id="createPanelBtn"
      class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 rounded-full">Create Panel</button>

    <pre id="result" class="whitespace-pre-wrap text-sm mt-6 bg-white/10 rounded p-4 hidden fade-in"></pre>
    <pre id="error" class="whitespace-pre-wrap text-sm text-red-300 mt-4 hidden"></pre>
  </div>

  <script>
    const planSpecs = {
      "1gb-v2": { ram: 1024, disk: 1024, cpu: 50 },
      "2gb-v2": { ram: 2048, disk: 2048, cpu: 50 },
      "3gb-v2": { ram: 3072, disk: 3072, cpu: 50 }
    };

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginSection = document.getElementById('loginSection');
    const panelSection = document.getElementById('panelSection');
    const loginError = document.getElementById('loginError');

    loginBtn.onclick = () => {
      const u = document.getElementById('loginUsername').value.trim();
      const p = document.getElementById('loginPassword').value.trim();
      const users = JSON.parse(localStorage.getItem('users')) || [];
      const found = users.find(x => x.username === u && x.password === p);
      if (found) {
        localStorage.setItem('currentUser', u);
        showPanel();
      } else {
        loginError.textContent = "❌ Username atau password salah!";
        loginError.classList.remove('hidden');
      }
    };

    logoutBtn.onclick = () => {
      localStorage.removeItem('currentUser');
      showLogin();
    };

    function showPanel() {
      loginSection.classList.add('hidden');
      panelSection.classList.remove('hidden');
    }

    function showLogin() {
      loginSection.classList.remove('hidden');
      panelSection.classList.add('hidden');
    }

    if (localStorage.getItem('currentUser')) showPanel();

    document.getElementById('createPanelBtn').onclick = async () => {
      const panelName = document.getElementById('panelName').value.trim();
      const plan = document.getElementById('panelPlan').value;
      const resultDiv = document.getElementById('result');
      const errorDiv = document.getElementById('error');

      resultDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');

      if (!panelName || !plan || !(plan in planSpecs)) {
        errorDiv.textContent = "❌ Isi nama panel & pilih plan!";
        errorDiv.classList.remove('hidden');
        return;
      }

      const specs = planSpecs[plan];
      const username = panelName.toLowerCase().replace(/\s+/g, '') + Date.now();
      const email = `${username}@xemz.id`;
      const password = username + "123";
      const name = panelName.charAt(0).toUpperCase() + panelName.slice(1);

      try {
        resultDiv.textContent = "⏳ Membuat user...";
        resultDiv.classList.remove('hidden');

        const userRes = await fetch('/api/relay', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "create_user",
            payload: {
              email, username, first_name: name, last_name: "Server", password
            }
          })
        });

        const userJson = await userRes.json();
        if (!userJson.success) throw new Error("❌ Gagal buat user:\n" + JSON.stringify(userJson.details || userJson.raw));
        const userId = userJson.data.attributes.id;

        resultDiv.textContent += "\n✅ User dibuat. Membuat server...";

        const serverRes = await fetch('/api/relay', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "create_server",
            payload: {
              name: name + "-server",
              user: userId,
              egg: 15,
              nest: 5,
              docker_image: "ghcr.io/parkervcp/yolks:nodejs_18",
              startup: "npm start",
              limits: {
                memory: specs.ram,
                swap: 0,
                disk: specs.disk,
                io: 500,
                cpu: specs.cpu
              },
              feature_limits: { databases: 1, backups: 1, allocations: 1 },
              deploy: { locations: [1], dedicated_ip: false, port_range: [] },
              environment: {
                INST: "npm",
                USER_UPLOAD: "0",
                AUTO_UPDATE: "0",
                CMD_RUN: "npm start"
              }
            }
          })
        });

        const serverJson = await serverRes.json();
        if (!serverJson.success) throw new Error("❌ Gagal buat server:\n" + JSON.stringify(serverJson.details || serverJson.raw));

        resultDiv.textContent += `
✅ Server Created!
👤 Username: ${username}
📧 Email: ${email}
🔑 Password: ${password}
🗂️ Server ID: ${serverJson.data.attributes.id}
📅 Tanggal: ${new Date().toLocaleString()}
`;

      } catch (err) {
        errorDiv.textContent = err.message;
        errorDiv.classList.remove('hidden');
        resultDiv.classList.add('hidden');
      }
    };
  </script>
</body>
</html>
